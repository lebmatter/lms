{% if frappe.session.user != "Guest" %}
{% set membership = frappe.db.get_value("LMS Exam Submission",
{"candidate": frappe.session.user, "exam": exam.name},
["name", "course", "progress"], as_dict=1) %}
{% set progress_status = membership.progress %}
{% else %}
{% set membership, progress = None, None %}
{% endif %}
{% if progress == "Completed" %}
{% set progress = 100 %}
{% else %}
{% set progress = 0 %}
{% endif %}

<div class="common-card-style course-card" data-course="{{ exam.name }}">

    <div class="course-image {% if not exam.image %} default-image {% endif %}" {% if exam.image %}
        style="background-image: url( {{ exam.image | urlencode }} );" {% endif %}>
        <div class="course-tags">
            {% for tag in get_tags(exam.name) %}
            <div class="course-card-pills">{{ tag }}</div>
            {% endfor %}
        </div>
        {% if not exam.image %}
        <div class="default-image-text">{{ exam.title[0] }}</div>
        {% endif %}
    </div>


    <div class="course-card-content">
        <div class="course-card-meta">
            {% if exam.status and exam.status != "Approved" %}
            {% set pill_color = "gray" if exam.status == "In Progress" else "orange" %}
            <div class="pull-right indicator-pill {{ pill_color }} "> {{ exam.status }} </div>
            {% endif %}

            {% set student_count = get_students(exam.name) | length %}
            {% set avg_rating = get_average_rating(exam.name) %}
            {% if student_count %}
            <div class="vertically-center">
                <svg class="icon  icon-md">
                    <use class="" href="#icon-users">
                </svg>
                {{ student_count }}
            </div>
            {% endif %}

            {% if avg_rating %}
            <div class="vertically-center">
                <svg class="icon icon-md">
                    <use href="#icon-star"></use>
                </svg>
                {{ frappe.utils.flt(avg_rating, frappe.get_system_settings("float_precision") or 3) }}
            </div>
            {% endif %}

            {% if exam.paid_certificate %}
            <div class="vertically-center">
                <svg class="icon icon-md">
                    <use href="#icon-badge"></use>
                </svg>
                <span class="certificate-price" data-price="{{ exam.price_certificate }}">
                    {{ format_amount(exam.price_certificate, exam.currency) }}
                </span>
            </div>
            {% endif %}
        </div>
        <div class="course-card-title">{{ exam.title }}</div>

        {% if membership and not is_instructor(exam.name) and not read_only %}
        <div class="progress">
            <div class="progress-bar" role="progressbar" aria-valuenow="{{ progress }}" aria-valuemin="0"
                aria-valuemax="100" style="width:{{ progress }}%">
                <span class="sr-only"> {{ progress }} {{ _("Complete") }} </span>
            </div>
        </div>
        <div class="progress-percent">{{ progress }}% {{ _("Completed") }} </div>
        {% endif %}

        {% if read_only %}
        <a class="stretched-link" href="/exams/{{ exam.name }}"></a>
        {% else %}
        {% if progress == 100 and membership and not exam.upcoming %}
        {% else %}
        <a class="stretched-link" href="/exams/{{ exam.name }}"></a>
        {% endif %}
        {% endif %}
    </div>
</div>